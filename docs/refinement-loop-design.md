# StoryFold 循环改进模块设计方案

本文档基于行业最佳实践与现有架构（architecture.md 3.6.1、initial-idea-v2 业务环节），设计**可复用于各创作阶段的循环改进业务模块**：判断当前状态、提出修改意见、提交修改，并支持用户参与方式（修改上轮结果、修改意见、同意、或设定自动循环与次数等）。

---

## 一、行业最佳实践摘要

### 1.1 迭代修订与反馈循环

| 来源 | 核心做法 | 可借鉴点 |
|------|----------|----------|
| **Read, Revise, Repeat (R3)** (Du et al., In2Writing 2022) | 模型给出修订建议 → 用户**接受/拒绝**每条建议 → 接受的纳入下一轮；直到模型不再建议或达到**最大轮数** | 最小化用户操作（仅接受/拒绝），明确**停止条件**（无新建议或 max 轮数） |
| **Self-Refine** | **反馈 → 精修 → 再反馈**：单模型既生成又自评；强调**可操作的、具体到位置的反馈**；在 prompt 中保留**历史输出**避免重复错误 | 反馈需**具体、可执行**；保留**历史**供下一轮参考 |
| **Synthia** (学术 UX) | 将大量反馈**聚类、可视化**，与原文**双向高亮**关联；用户可**选择性组合**多条反馈再生成多种修订方案 | 反馈与原文**锚定**；支持**选择性采纳**与多方案探索 |
| **LangGraph Human-in-the-Loop** | 在流程节点处**中断**，**持久化状态**为 checkpoint；用户可**审查/编辑状态**后再继续、或取消 | **状态快照** + **中断点**；支持「先改状态再继续」 |
| **Draf / Reproof** | 从用户历史修订中学习；**段落级版本**、多方案并排；AI 作为编辑助手提供**替代版本**供选择 | 版本化、多方案并排、用户偏好学习（可后续扩展） |

### 1.2 设计原则归纳

- **闭环**：**状态判断 → 建议 → 用户决策 → 执行（修订）→ 再判断**，形成可重复的一轮。
- **可操作反馈**：建议需**具体**（指出问题与改进方向），便于用户理解与执行。
- **用户主权**：支持「全部采纳 / 部分采纳 / 拒绝 / 先改内容再继续 / 改建议再跑」等多种参与方式。
- **停止条件**：最大轮数、用户主动结束、或系统判断「无需再改」。
- **状态与历史**：每轮状态与建议持久化，支持中断后从 checkpoint 恢复或回溯。

---

## 二、业务定位与适用范围

### 2.1 适用阶段

循环改进模块**可复用于**以下每个创作阶段（与现有 workflow 一一对应）：

| 阶段 | 当前产出 | 循环改进的「当前内容」 | 判断/建议侧重 |
|------|----------|------------------------|---------------|
| 需求 | brief.json (写作要点) | 写作要点文本 | 完整性、结构化程度、与初步需求契合度 |
| 提纲及其备注 | outline.json | 提纲及其备注文本 | 结构清晰度、设定与场景备注是否到位、一致性 |
| 样段 | samples.json | 样段文本 | 与要点/提纲一致、风格与节奏 |
| 最终作品 | final.json | 最终作品正文 | 与提纲/样段一致、多角色审读与适龄自检中的问题 |

每一阶段均可独立进入「循环改进」：**判断当前状态 → 生成修改建议 → 用户选择如何响应 → 执行修订（或手动改）→ 再判断**。

### 2.2 与现有能力的关系

- **多角色审读、适龄自检**：已有点评类输出；循环改进模块可将其作为**建议来源之一**，并增加「按建议修订」的**执行步骤**与**轮次控制**。
- **在编辑器中编辑**：用户手动修改后，可主动触发「重新判断」或「根据当前内容再跑一轮建议」，形成「手动改 → 再评估」子循环。
- **运行占位流程**：仍是「一键生成当前阶段」；循环改进是在**已有一次产出之后**的「评估 → 建议 → 修订」增强。

---

## 三、状态与数据模型

### 3.1 循环状态（可持久化）

建议在项目目录下用**单一 JSON** 记录当前循环状态，便于中断与恢复；或按阶段写入各阶段 JSON 的 `meta` 字段。以下按「单文件」设计，路径如 `.storyfold/refinementState.json`。

```ts
// 建议的 TypeScript 类型（可放在 types.ts）
interface RefinementState {
  phase: 'brief' | 'outline' | 'sample' | 'final';  // 当前阶段
  round: number;                                     // 当前轮次（从 1 开始）
  maxRounds?: number;                                // 用户设定的最大轮数（可选）
  mode: 'manual' | 'auto';                           // 本阶段为手动推进或自动循环
  lastAssessedAt?: number;                           // 上次「判断」时间戳
  lastRevisedAt?: number;                             // 上次「执行修订」时间戳
  focus?: string;                                    // 可选：当前焦点（如「第3章」），长篇时用
  scope?: 'full' | 'section';                        // 可选：当前判断范围（全文 / 当前节）
}
```

- **phase**：与 workflow 对应，决定读取哪个 JSON、调用哪个「判断」与「修订」逻辑。
- **round / maxRounds**：用于停止条件（达到 max 或用户不再继续）。
- **mode**：手动 = 每轮后等用户操作；自动 = 达到 maxRounds 前自动跑「判断 → 修订」。
- **focus / scope**：为后续「先粗后细、由近到远」预留，MVP 可仅用 `phase` + `round`。

### 3.2 建议列表（单轮输出）

每轮「判断」产出**建议列表**，可持久化到同文件或单独 `refinementSuggestions.json`，便于在 UI 中展示与「部分采纳」。

```ts
interface RefinementSuggestion {
  id: string;           // 唯一 id，便于采纳/拒绝时引用
  type: 'consistency' | 'completeness' | 'style' | 'safety' | 'logic' | 'other';
  summary: string;      // 简短摘要（如「第 2 段与提纲中时间线不一致」）
  detail?: string;      // 详细说明或修改方向
  anchor?: string;      // 可选：锚定到原文的片段或位置（供高亮/定位）
  severity?: 'info' | 'suggestion' | 'should_fix';   // 可选：优先级
}

interface RefinementRound {
  round: number;
  assessedAt: number;
  suggestions: RefinementSuggestion[];
  userDecision?: 'accept_all' | 'accept_selected' | 'reject' | 'edit_then_retry' | 'done';
  acceptedIds?: string[];   // 若为 accept_selected，记录采纳的 id
}
```

- **userDecision**：用户在本轮的选择（全部采纳 / 部分采纳 / 拒绝 / 先编辑再重跑 / 结束）。
- **acceptedIds**：部分采纳时记录哪些建议被采纳，供「执行修订」时只针对这些项生成补丁或改写。

### 3.3 历史轮次（可选）

保留最近 N 轮的 `RefinementRound` 列表，便于：
- 用户查看「上一轮建议与我的选择」；
- LLM 在下一轮 prompt 中引用「上一轮已采纳/已拒绝」避免重复。

---

## 四、流程与决策树

### 4.1 单轮循环（抽象）

```
[ 读取当前阶段内容 ] → [ 判断状态 + 生成建议 ] → [ 展示建议 + 等待用户决策 ]
        ↑                                                      |
        |                                                      v
        |              [ 用户决策：采纳(全部/部分) / 拒绝 / 先编辑再跑 / 结束 ]
        |                                                      |
        |     ┌────────────────────────────────────────────────┼─────────────────────────────────┐
        |     |                    |                    |                    |                    |
        |     v                    v                    v                    v                    v
        |  执行修订           不执行修订          打开编辑器           结束循环            结束循环
        |  (按采纳项)         下一轮可再判        用户改完可           保存状态            保存状态
        |     |               或结束              点「再评估」              |                    |
        |     v                                    |                      v                    v
        |  写回 JSON                                |                  [ 可进入下一阶段 ]
        |  更新 round ──────────────────────────────┘
        |
        └── 若 mode=auto 且 round < maxRounds，可自动再跑「判断」开始下一轮
```

### 4.2 用户参与方式（与 UI 对应）

| 用户操作 | 含义 | 系统行为 |
|----------|------|----------|
| **全部采纳** | 按本轮所有建议修订 | 调用「修订」workflow（传入当前内容 + 建议列表），写回对应 JSON，round+1，可自动再判断或等待 |
| **部分采纳** | 只采纳勾选的建议 | 同上，但只传入 `acceptedIds` 对应的建议 |
| **拒绝** | 本轮建议不用 | 不执行修订；可「再跑一轮判断」或「结束」 |
| **先编辑再跑** | 用户自己去编辑器改内容 | 打开对应「在编辑器中编辑」；用户保存后，可点「重新判断」再生成新建议 |
| **同意 / 结束** | 当前阶段满意，不再循环 | 持久化 state（round、done），可选提示「可进入下一阶段」 |
| **自动循环** | 设定轮数后自动跑多轮 | mode=auto，maxRounds=N；每轮「判断→建议→执行修订（全部采纳）」自动进行，直到 round=N 或建议为空，再交回用户 |

### 4.3 停止条件（汇总）

- 用户主动**结束**；
- **达到 maxRounds**（若设置了自动循环）；
- **判断结果为空**（无需改进）— 可由 LLM 或规则在「判断」步骤返回空列表；
- （可选）**连续两轮建议集合相同或变化极小**，视为收敛。

---

## 五、判断与修订的职责划分

### 5.1 「判断」步骤（Assess）

- **输入**：当前阶段 phase、当前内容（从对应 JSON 读取）、可选上一轮 `RefinementRound`（避免重复建议）。
- **输出**：`RefinementSuggestion[]`；可选附带一句「整体评价」（如「整体一致，仅 2 处建议微调」）。
- **实现方式**：
  - **LLM**：按阶段使用不同 system prompt（brief/outline/sample/final），要求输出结构化建议列表（可约定 JSON 或 Markdown 列表），并解析为 `RefinementSuggestion[]`。
  - **规则/启发式**（可选）：如提纲与最终稿的章节标题匹配度、敏感词扫描等，作为补充。
- **一致性检查**：若该阶段已有「一致性检查」类能力（如提纲与备注的旧逻辑），可合并进「判断」或作为建议类型之一。

### 5.2 「修订」步骤（Revise）

- **输入**：当前内容、本轮采纳的 `RefinementSuggestion[]`（或全部建议）。
- **输出**：修订后的全文（或增量补丁，视实现难度选全文更简单）。
- **实现方式**：调用 LLM，将「当前内容 + 采纳的建议」作为 user message，要求按建议修改并输出完整修订版；写回对应 JSON。
- **与现有 workflow 关系**：可复用现有 `runOutlineDraft` / `runFinalDraft` 等的「根据上下文生成」能力，但 prompt 改为「在现有内容基础上按下列建议修改」，而不是从零生成。

### 5.3 模块边界

- **RefinementController**（或 `refinementLoop.ts`）：负责**编排**「读取状态 → 调用判断 → 持久化建议 → 等待用户决策 → 调用修订 → 更新状态与 round」。
- **各阶段 workflow**：可扩展为提供 `runAssess(phase, content)` 与 `runRevise(phase, content, suggestions)`，或由 RefinementController 内根据 phase 调用不同 prompt/子流程。
- **UI**：工作台内每阶段增加「循环改进」入口（如「对本阶段做一轮改进」）；展示当前 round、建议列表、操作按钮（全部采纳 / 勾选采纳 / 拒绝 / 先编辑 / 结束 / 自动 N 轮）。

---

## 六、UI 与交互要点

### 6.1 工作台内展示（建议）

- 在每个阶段区块（写作要点、提纲及其备注、样段、最终作品）下增加：
  - **「对本阶段做一轮改进」** 按钮 → 触发「判断」，展示本轮建议；
  - 若已存在本轮建议，则展示：
    - 建议列表（可多选）；
    - 按钮：「全部采纳并修订」「采纳所选并修订」「拒绝」「我先在编辑器中改」「结束本阶段改进」；
  - 若支持自动循环：输入框「自动轮数」+ 按钮「自动改进 N 轮」，进入 mode=auto 直到 N 轮或建议为空。

### 6.2 建议的展示形式

- **列表**：每条 `summary` + 可展开 `detail`；类型与 severity 用标签或图标区分。
- **与原文锚定**（后续增强）：若 `anchor` 存在，在「在编辑器中打开」的文档里高亮对应位置，或在工作台内短摘要旁显示「定位到第 X 段」。
- **多方案**（后续增强）：对某条建议生成 2～3 种修订方案供用户选，类似 Reproof 的段落多版本。

### 6.3 与编辑器的联动

- 用户点「我先在编辑器中改」：打开对应「在编辑器中编辑 xxx」；保存后，工作台可提示「已保存，是否重新判断？」。
- 「重新判断」：再次调用 Assess，用当前 JSON 内容生成新建议，覆盖当前轮建议列表。

---

## 七、配置与扩展点

### 7.1 配置项建议（package.json）

- `storyfold.refinement.maxRoundsDefault`：默认最大轮数（如 3）。
- `storyfold.refinement.autoApplyWhenSingleSuggestion`：当仅 1 条建议时是否询问后自动采纳（可选）。
- （可选）`storyfold.refinement.assessModel` / `storyfold.refinement.reviseModel`：与主流程不同的模型，用于判断/修订以节省成本或提升质量。

### 7.2 扩展点

- **建议类型与 severity**：后续可增加更多 type（如 `fact_check`、`age_appropriateness`），与多角色审读、适龄自检打通。
- **焦点与范围**：长篇时引入 `focus`（当前章/节）、`scope`（全文 vs 当前节），实现「先整体后局部、由近到远」的细化顺序。
- **历史与回溯**：保存多轮 RefinementRound，支持「回到第 N 轮的状态」或「对比两轮建议差异」。

---

## 八、实现顺序建议

1. **MVP（第一版）**
   - 状态与建议数据模型（`RefinementState`、`RefinementSuggestion`、单轮持久化）。
   - 仅支持**一个阶段**（如「最终作品」）：判断 = 基于多角色审读/适龄自检或一次专用 Assess 调用；修订 = 一次 Revise 调用写回 final.json。
   - UI：该阶段下「做一轮改进」→ 展示建议 →「全部采纳并修订」/「结束」。
   - 手动模式即可；round 与 maxRounds 可先固定为 3。

2. **第二版**
   - 将循环改进推广到**四个阶段**（brief / outline / sample / final），每阶段独立的 Assess/Revise prompt。
   - 用户选择：全部采纳 / 部分采纳（勾选）/ 拒绝 / 先编辑再判断 / 结束。
   - 自动循环：设定 maxRounds，自动执行「判断→全部采纳→修订」直到轮数用尽或建议为空。

3. **第三版（可选）**
   - 建议与原文锚定、多方案并排、历史轮次回溯、focus/scope 支持长篇。

---

## 九、与现有文档的对应

| 文档位置 | 对应本方案 |
|----------|------------|
| architecture.md 3.6.1 状态模型 | 本方案 §3.1 RefinementState（phase, round, focus, scope） |
| architecture.md 3.6.1 状态检测/判断 | 本方案 §5.1 Assess：一致性、完整性、可操作建议列表 |
| architecture.md 3.6.1 决策 | 本方案 §4.2 用户参与方式与 §4.3 停止条件 |
| architecture.md 3.6.1 循环落点 | 本方案 §5.3 RefinementController + 各阶段 Assess/Revise |
| initial-idea-v2 先粗后细、多重修改 | 本方案 round、maxRounds、可选 focus/scope |
| initial-idea-v2 人机交互完善 | 本方案 全部/部分采纳、先编辑再跑、结束 |

---

*本文档为设计方案，具体 API 与文件路径可在实现时再与现有 `workflow/`、`storage/`、`ui/webviewManager` 对齐。*
